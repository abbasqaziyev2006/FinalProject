@using EcommerceCoza.BLL.ViewModels
@model ProductViewModel
@inject WebApplication4.Services.ICurrencyService CurrencyService
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

<main class="pt-90">
    <div class="mb-5 pb-5"></div>
    <section class="product-single container">
        <div class="row">
            <div class="col-lg-7">
                <div class="product-single__media" data-media-type="vertical-thumbnail">
                    @if (Model.ProductVariants.Any() && (Model.ProductVariants.First().ImageNames.Any() || !string.IsNullOrEmpty(Model.ProductVariants.First().CoverImageName)))
                    {
                        var firstVariant = Model.ProductVariants.First();
                        <div class="product-single__image">
                            <div class="swiper-container">
                                <div class="swiper-wrapper">
                                    @* Cover Image *@
                                    @if (!string.IsNullOrEmpty(firstVariant.CoverImageName))
                                    {
                                        <div class="swiper-slide product-single__image-item">
                                            <img loading="lazy" class="h-auto" src="~/images/products/@firstVariant.CoverImageName" width="674"
                                                 height="674" alt="@Model.Name" />
                                            <a data-fancybox="gallery" href="~/images/products/@firstVariant.CoverImageName" data-bs-toggle="tooltip"
                                               data-bs-placement="left" title="Zoom">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <use href="#icon_zoom" />
                                                </svg>
                                            </a>
                                        </div>
                                    }
                                    @* Additional Images *@
                                    @foreach (var imageName in firstVariant.ImageNames)
                                    {
                                        <div class="swiper-slide product-single__image-item">
                                            <img loading="lazy" class="h-auto" src="~/images/products/@imageName" width="674"
                                                 height="674" alt="@Model.Name" />
                                            <a data-fancybox="gallery" href="~/images/products/@imageName" data-bs-toggle="tooltip"
                                               data-bs-placement="left" title="Zoom">
                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <use href="#icon_zoom" />
                                                </svg>
                                            </a>
                                        </div>
                                    }
                                </div>
                                <div class="swiper-button-prev">
                                    <svg width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
                                        <use href="#icon_prev_sm" />
                                    </svg>
                                </div>
                                <div class="swiper-button-next">
                                    <svg width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
                                        <use href="#icon_next_sm" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="product-single__thumbnail">
                            <div class="swiper-container">
                                <div class="swiper-wrapper">
                                    @if (!string.IsNullOrEmpty(firstVariant.CoverImageName))
                                    {
                                        <div class="swiper-slide product-single__image-item">
                                            <img loading="lazy" class="h-auto"
                                                 src="~/images/products/@firstVariant.CoverImageName" width="104" height="104" alt="@Model.Name" />
                                        </div>
                                    }
                                    @foreach (var imageName in firstVariant.ImageNames)
                                    {
                                        <div class="swiper-slide product-single__image-item">
                                            <img loading="lazy" class="h-auto"
                                                 src="~/images/products/@imageName" width="104" height="104" alt="@Model.Name" />
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="product-single__image">
                            <img loading="lazy" class="h-auto" src="~/images/products/product-placeholder.jpg" width="674"
                                 height="674" alt="@Model.Name" />
                        </div>
                    }
                </div>
            </div>
            <div class="col-lg-5">
                <div class="d-flex justify-content-between mb-4 pb-md-2">
                    <div class="breadcrumb mb-0 d-none d-md-block flex-grow-1">
                        <a asp-controller="Home" asp-action="Index" class="menu-link menu-link_us-s text-uppercase fw-medium">@Localizer["Home"]</a>
                        <span class="breadcrumb-separator menu-link fw-medium ps-1 pe-1">/</span>
                        <a asp-controller="Shop" asp-action="Index" class="menu-link menu-link_us-s text-uppercase fw-medium">@Localizer["Shop"]</a>
                        @if (Model.Category != null)
                        {
                            <span class="breadcrumb-separator menu-link fw-medium ps-1 pe-1">/</span>
                            <span class="menu-link menu-link_us-s text-uppercase fw-medium">@Model.Category.Name</span>
                        }
                    </div>
                </div>
                <h1 class="product-single__name">@Model.Name</h1>

                @* Brand Display *@
                @if (Model.Brand != null)
                {
                    <div class="product-single__brand mb-3">
                        <span class="text-muted">@Localizer["Brand"]:</span>
                        <strong class="text-primary ms-2">@Model.Brand.Name</strong>
                    </div>
                }

                <div class="product-single__rating d-flex align-items-center" data-rating="@Model.Rating" data-review-count="@Model.ReviewCount">
                    <div class="reviews-group d-flex">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= Model.Rating)
                            {
                                <svg class="review-star active" viewBox="0 0 9 9" xmlns="http://www.w3.org/2000/svg">
                                    <use href="#icon_star" />
                                </svg>
                            }
                            else
                            {
                                <svg class="review-star" viewBox="0 0 9 9" xmlns="http://www.w3.org/2000/svg">
                                    <use href="#icon_star" />
                                </svg>
                            }
                        }
                    </div>
                    <span class="reviews-note text-lowercase text-secondary ms-1">
                        @if (Model.ReviewCount > 0)
                        {
                            <text>@Model.ReviewCount reviews</text>
                        }
                        else
                        {
                            <text>@Localizer["No Reviews Yet"]</text>
                        }
                    </span>
                </div>
                <div class="product-single__price">
                    <span class="current-price">@CurrencyService.Format(Model.BasePrice)</span>
                </div>
                <form name="addtocart-form" method="post" id="addToCartForm">
                    @if (Model.ProductVariants.Any())
                    {
                        <div class="product-single__swatches">
                            @* Size Selection *@
                            @{
                                var uniqueSizes = Model.ProductVariants
                                .Where(v => !string.IsNullOrEmpty(v.Size))
                                .Select(v => v.Size)
                                .Distinct()
                                .ToList();
                            }
                            @if (uniqueSizes.Any())
                            {
                                <div class="product-swatch text-swatches mb-3">
                                    <label>@Localizer["Size"]</label>
                                    <div class="swatch-list">
                                        @foreach (var size in uniqueSizes)
                                        {
                                            <input type="radio"
                                                   name="size"
                                                   id="size_@size"
                                                   value="@size"
                                                   class="swatch-input"
                                                   @(uniqueSizes.First() == size ? "checked" : "")>
                                            <label class="swatch js-swatch" for="size_@size" title="@size">
                                                @size
                                            </label>
                                        }
                                    </div>
                                </div>
                            }

                            @* Color Selection *@
                            <div class="product-swatch text-swatches">
                                <label>@Localizer["Color"]</label>
                                <div class="swatch-list">
                                    @foreach (var variant in Model.ProductVariants.GroupBy(v => v.ColorId).Select(g => g.First()))
                                    {
                                        <input type="radio"
                                               name="color"
                                               id="color_@variant.ColorId"
                                               value="@variant.ColorId"
                                               data-variant-id="@variant.Id"
                                               data-color-id="@variant.ColorId"
                                               data-cover-image="@variant.CoverImageName"
                                               data-stock="@variant.Quantity"
                                               class="swatch-input"
                                               @(Model.ProductVariants.First().ColorId == variant.ColorId ? "checked" : "")>
                                        <label class="swatch js-swatch"
                                               for="color_@variant.ColorId"
                                               title="@variant.ColorName"
                                               style="@(!string.IsNullOrEmpty(variant.ColorHexCode) ? $"background-color: {variant.ColorHexCode};" : "")">
                                            @if (string.IsNullOrEmpty(variant.ColorHexCode) && !string.IsNullOrEmpty(variant.ColorIconName))
                                            {
                                                <img src="~/Uploads/@variant.ColorIconName" alt="@variant.ColorName" style="width: 30px; height: 30px; border-radius: 50%;" />
                                            }
                                            else if (string.IsNullOrEmpty(variant.ColorHexCode))
                                            {
                                                <span>@variant.ColorName</span>
                                            }
                                        </label>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                    <div class="product-single__addtocart">
                        <div class="qty-control position-relative">
                            <input type="number" name="quantity" id="quantity" value="1" min="1" max="@(Model.ProductVariants.FirstOrDefault()?.Quantity ?? 1)" class="qty-control__number text-center">
                            <div class="qty-control__reduce">-</div>
                            <div class="qty-control__increase">+</div>
                        </div>
                        <input type="hidden" name="productVariantId" id="productVariantId" value="@Model.ProductVariants.FirstOrDefault()?.Id" />
                        <button type="submit" class="btn btn-primary btn-addtocart" id="addToCartBtn">
                            @Localizer["Add To Cart"]
                        </button>
                    </div>
                </form>
                <div class="product-single__addtolinks">
                    <a href="#" class="menu-link menu-link_us-s js-add-wishlist @(Model.IsInWishlist ? "active" : "")" data-product-id="@Model.Id">
                        <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <use href="#icon_heart" />
                        </svg><span>@Localizer["Add To Wishlist"]</span>
                    </a>
                    <share-button class="share-button">
                        <button class="menu-link menu-link_us-s to-share border-0 bg-transparent d-flex align-items-center">
                            <svg width="16" height="19" viewBox="0 0 16 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <use href="#icon_sharing" />
                            </svg>
                            <span>@Localizer["Share"]</span>
                        </button>
                    </share-button>
                </div>
                <div class="product-single__meta-info">
                    <div class="meta-item">
                        <label>SKU:</label>
                        <span>@Model.Id</span>
                    </div>
                    @if (Model.Category != null)
                    {
                        <div class="meta-item">
                            <label>@Localizer["Category"]:</label>
                            <span>@Model.Category.Name</span>
                        </div>
                    }
                    @if (Model.ProductVariants.Any())
                    {
                        <div class="meta-item">
                            <label>@Localizer["Availability"]:</label>
                            <span id="stock-status">
                                @if (Model.ProductVariants.First().Quantity > 0)
                                {
                                    <span class="text-success">@Localizer["InStock"] (@Model.ProductVariants.First().Quantity @Localizer["Available"])</span>
                                }
                                else
                                {
                                    <span class="text-danger">@Localizer["OutOfStock"]</span>
                                }
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="product-single__details-tab">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link nav-link_underscore active" id="tab-description-tab" data-bs-toggle="tab"
                       href="#tab-description" role="tab" aria-controls="tab-description" aria-selected="true">@Localizer["Description"]</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link nav-link_underscore" id="tab-additional-info-tab" data-bs-toggle="tab"
                       href="#tab-additional-info" role="tab" aria-controls="tab-additional-info"
                       aria-selected="false">@Localizer["AdditionalInformation"]</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-description" role="tabpanel"
                     aria-labelledby="tab-description-tab">
                    <div class="product-single__description">
                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <div class="product-description-content">
                                @Html.Raw(Model.Description)
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">@Localizer["NoDescriptionAvailable"]</p>
                        }
                    </div>
                </div>
                <div class="tab-pane fade" id="tab-additional-info" role="tabpanel" aria-labelledby="tab-additional-info-tab">
                    <div class="product-single__addtional-info">
                        @if (!string.IsNullOrEmpty(Model.AdditionalInformation))
                        {
                            <div class="additional-info-content">
                                @Html.Raw(Model.AdditionalInformation)
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <tbody>
                                        @if (Model.Brand != null)
                                        {
                                            <tr>
                                                <th class="bg-light" style="width: 200px;">@Localizer["Brand"]</th>
                                                <td>@Model.Brand.Name</td>
                                            </tr>
                                        }
                                        @if (Model.Category != null)
                                        {
                                            <tr>
                                                <th class="bg-light">@Localizer["Category"]</th>
                                                <td>@Model.Category.Name</td>
                                            </tr>
                                        }
                                        @if (Model.ProductVariants.Any())
                                        {
                                            var uniqueSizes = Model.ProductVariants.Where(v => !string.IsNullOrEmpty(v.Size)).Select(v => v.Size).Distinct();
                                            if (uniqueSizes.Any())
                                            {
                                                <tr>
                                                    <th class="bg-light">@Localizer["Available Sizes"]</th>
                                                    <td>@string.Join(", ", uniqueSizes)</td>
                                                </tr>
                                            }

                                            var uniqueColors = Model.ProductVariants.Select(v => v.ColorName).Distinct();
                                            if (uniqueColors.Any())
                                            {
                                                <tr>
                                                    <th class="bg-light">@Localizer["Available Colors"]</th>
                                                    <td>@string.Join(", ", uniqueColors)</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

@section Scripts {
    <script>
        $(document).ready(function () {
            const variants = @Html.Raw(Json.Serialize(Model.ProductVariants));

            function updateVariantSelection() {
                const selectedSize = $('input[name="size"]:checked').val() || '';
                const selectedColorId = parseInt($('input[name="color"]:checked').data('color-id'));

                const matchingVariant = variants.find(v =>
                    v.colorId === selectedColorId &&
                    (selectedSize === '' || v.size === selectedSize || v.size === null || v.size === '')
                );

                if (matchingVariant) {
                    $('#productVariantId').val(matchingVariant.id);
                    $('#quantity').attr('max', matchingVariant.quantity);

                    // Update stock status
                    if (matchingVariant.quantity > 0) {
                        $('#stock-status').html('<span class="text-success">@Localizer["InStock"] (' + matchingVariant.quantity + ' @Localizer["Available"])</span>');
                        $('#addToCartBtn').prop('disabled', false);
                    } else {
                        $('#stock-status').html('<span class="text-danger">@Localizer["OutOfStock"]</span>');
                        $('#addToCartBtn').prop('disabled', true);
                    }

                    // Update main image if needed
                    if (matchingVariant.coverImageName) {
                        $('.product-single__image .swiper-slide:first img').attr('src', '/images/products/' + matchingVariant.coverImageName);
                    }
                }
            }

            // Handle size and color selection
            $('input[name="size"], input[name="color"]').on('change', updateVariantSelection);

            // Handle quantity controls
            $('.qty-control__increase').on('click', function () {
                const input = $(this).siblings('.qty-control__number');
                const max = parseInt(input.attr('max'));
                const current = parseInt(input.val());
                if (current < max) {
                    input.val(current + 1);
                }
            });

            $('.qty-control__reduce').on('click', function () {
                const input = $(this).siblings('.qty-control__number');
                const min = parseInt(input.attr('min'));
                const current = parseInt(input.val());
                if (current > min) {
                    input.val(current - 1);
                }
            });

            // Handle form submission
            $('#addToCartForm').on('submit', function (e) {
                e.preventDefault();

                const variantId = $('#productVariantId').val();
                const quantity = $('#quantity').val();

                if (!variantId) {
                    alert('@Localizer["PleaseSelectVariant"]');
                    return;
                }

                const formData = new FormData();
                formData.append('productVariantId', variantId);
                formData.append('quantity', quantity);

                $.ajax({
                    url: '/Basket/Add',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        // Update cart count
                        $.get('/Basket/GetBasket', function (data) {
                            $('.header__cart-count').text(data.totalCount);
                        });

                        alert('@Localizer["ProductAddedToCart"]');
                    },
                    error: function () {
                        alert('@Localizer["ErrorAddingToCart"]');
                    }
                });
            });
        });
    </script>
}