@model EcommerceCoza.BLL.ViewModels.BasketViewModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@inject WebApplication4.Services.ICurrencyService CurrencyService

<main class="bg-light" style="padding-top: 120px; padding-bottom: 60px; min-height: 100vh;">
    <div class="container" style="max-width: 1400px;">
        <div class="row">
            <!-- Left side - Shopping Cart -->
            <div class="col-lg-8 mb-3">
                <div class="bg-white rounded shadow-sm p-4">
                    <h2 class="h4 mb-4">
                        @Localizer["ShoppingCart"]
                    </h2>

                    @if (Model.Items.Any())
                    {
                        <!-- Header -->
                        <div class="row border-bottom pb-2 mb-3">
                            <div class="col text-end">
                                <small class="text-muted">@Localizer["Price"]</small>
                            </div>
                        </div>

                        @foreach (var item in Model.Items)
                        {
                            <div class="cart-item border-bottom py-3 mb-3" data-variant-id="@item.ProductVariantId">
                                <div class="row align-items-center">
                                    <!-- Product Image -->
                                    <div class="col-auto">
                                        <img src="~/images/products/@item.ImageName"
                                             alt="@item.ProductName"
                                             class="rounded"
                                             style="width: 120px; height: 150px; object-fit: cover;">
                                    </div>

                                    <!-- Product Details -->
                                    <div class="col">
                                        <h5 class="mb-2 fw-normal">@item.ProductName</h5>
                                        <p class="text-muted mb-3" style="font-size: 14px;">
                                            <strong>@Localizer["Color"]:</strong> @item.ColorName
                                        </p>

                                        <!-- Quantity Controls -->
                                        <div class="d-flex align-items-center gap-2">
                                            <button type="button"
                                                    class="qty-btn qty-decrease btn btn-sm border-0 bg-light"
                                                    data-variant-id="@item.ProductVariantId"
                                                    style="width: 30px; height: 30px; border-radius: 4px;">
                                                −
                                            </button>

                                            <span class="qty-display px-3 fw-normal"
                                                  data-variant-id="@item.ProductVariantId"
                                                  style="font-size: 16px; min-width: 30px; text-align: center; display: inline-block;">
                                                @item.Quantity
                                            </span>

                                            <button type="button"
                                                    class="qty-btn qty-increase btn btn-sm border-0 bg-light"
                                                    data-variant-id="@item.ProductVariantId"
                                                    style="width: 30px; height: 30px; border-radius: 4px;">
                                                +
                                            </button>

                                            <button type="button"
                                                    class="btn-delete btn btn-link text-decoration-none text-dark p-0 ms-2"
                                                    data-variant-id="@item.ProductVariantId"
                                                    style="font-size: 14px;">
                                                @Localizer["Delete"]
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Price -->
                                    <div class="col-auto text-end">
                                        <p class="fw-bold mb-0 item-price" style="font-size: 20px;">
                                            @CurrencyService.Format(item.TotalPrice)
                                        </p>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Subtotal at bottom -->
                        <div class="text-end mt-4 pt-3 border-top">
                            <p class="mb-0">
                                <span class="text-muted">@Localizer["Subtotal"] (@Model.TotalCount @Localizer["Items"]):</span>
                                <strong class="ms-3" style="font-size: 20px;" id="cart-subtotal-bottom">
                                    @CurrencyService.Format(Model.TotalPrice)
                                </strong>
                            </p>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="1" class="mb-3">
                                <circle cx="9" cy="21" r="1" />
                                <circle cx="20" cy="21" r="1" />
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                            </svg>
                            <h5 class="mb-3">@Localizer["YourBasketIsEmpty"]</h5>
                            <a asp-controller="Shop" asp-action="Index" class="btn btn-primary px-4">
                                @Localizer["ContinueShopping"]
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Right side - Order Summary -->
            <div class="col-lg-4">
                @if (Model.Items.Any())
                {
                    <div class="bg-white rounded shadow-sm p-4">
                        <!-- Proceed to checkout button -->
                        <a asp-controller="Order"
                           asp-action="Checkout"
                           class="btn w-100 rounded-pill py-3 mb-4 text-uppercase fw-bold"
                           style="background: #ffd814; border: none; color: #000; font-size: 15px; letter-spacing: 0.5px;">
                            @Localizer["ProceedToCheckout"]
                        </a>

                        <!-- Subtotal -->
                        <div class="mb-3">
                            <p class="mb-2" style="font-size: 14px;">
                                <span class="text-muted">@Localizer["Subtotal"] (@Model.TotalCount @Localizer["Items"]):</span>
                            </p>
                            <p class="mb-0">
                                <strong style="font-size: 22px;" id="cart-subtotal">
                                    @CurrencyService.Format(Model.TotalPrice)
                                </strong>
                            </p>
                        </div>

                        <hr>

                        <!-- Coupon Code -->
                        <div class="mt-3">
                            <a href="#"
                               class="text-decoration-none text-primary"
                               data-bs-toggle="collapse"
                               data-bs-target="#couponCollapse"
                               style="font-size: 14px;">
                                @Localizer["EnterCouponCode"]
                            </a>
                            <div class="collapse mt-3" id="couponCollapse">
                                <form asp-action="ApplyCoupon" method="post" class="d-flex gap-2">
                                    <input type="text"
                                           name="couponCode"
                                           class="form-control"
                                           placeholder="@Localizer["EnterCode"]"
                                           style="font-size: 14px;">
                                    <button type="submit" class="btn btn-secondary" style="font-size: 14px;">
                                        @Localizer["Apply"]
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</main>

<style>
    body {
        background-color: #f5f5f5;
    }

    .cart-item:hover {
        background-color: #fafafa;
    }

    .qty-btn {
        color: #333;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 18px;
        font-weight: 300;
    }

        .qty-btn:hover {
            background-color: #e0e0e0 !important;
        }

        .qty-btn:active {
            transform: scale(0.95);
        }

    .btn-delete:hover {
        text-decoration: underline !important;
        color: #c7511f !important;
    }

    .btn[style*="background: #ffd814"]:hover {
        background-color: #f7ca00 !important;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            const currencySymbol = '@CurrencyService.GetSymbol()';

            // Increase quantity
            $(document).on('click', '.qty-increase', function () {
                const variantId = $(this).data('variant-id');
                changeQuantity(variantId, 1);
            });

            // Decrease quantity
            $(document).on('click', '.qty-decrease', function () {
                const variantId = $(this).data('variant-id');
                const $qtyDisplay = $(`.qty-display[data-variant-id="${variantId}"]`);
                const currentQty = parseInt($qtyDisplay.text());

                if (currentQty > 1) {
                    changeQuantity(variantId, -1);
                } else {
                    if (confirm('@Localizer["AreYouSureToRemove"]')) {
                        removeItem(variantId);
                    }
                }
            });

            // Delete button
            $(document).on('click', '.btn-delete', function () {
                const variantId = $(this).data('variant-id');
                if (confirm('@Localizer["AreYouSureToRemove"]')) {
                    removeItem(variantId);
                }
            });

            function changeQuantity(variantId, change) {
                const $item = $(`.cart-item[data-variant-id="${variantId}"]`);
                const $qtyDisplay = $item.find('.qty-display');
                const $buttons = $item.find('.qty-btn');

                $buttons.prop('disabled', true);

                $.ajax({
                    url: '@Url.Action("ChangeQuantity", "Basket")',
                    type: 'POST',
                    data: { productVariantId: variantId, change: change },
                    success: function (response) {
                        if (response.success && response.basketViewModel) {
                            const item = response.basketViewModel.items.find(x => x.productVariantId === variantId);
                            if (item) {
                                $qtyDisplay.text(item.quantity);
                                $item.find('.item-price').text(currencySymbol + ' ' + item.totalPrice.toFixed(2));
                                updateTotals();
                            }
                        }
                        $buttons.prop('disabled', false);
                    },
                    error: function () {
                        alert('@Localizer["ErrorUpdatingQuantity"]');
                        $buttons.prop('disabled', false);
                    }
                });
            }

            function removeItem(variantId) {
                $.ajax({
                    url: '@Url.Action("Remove", "Basket")',
                    type: 'POST',
                    data: { id: variantId },
                    success: function () {
                        $(`.cart-item[data-variant-id="${variantId}"]`).fadeOut(300, function () {
                            $(this).remove();
                            if ($('.cart-item').length === 0) {
                                location.reload();
                            } else {
                                updateTotals();
                            }
                        });
                    },
                    error: function () {
                        alert('@Localizer["ErrorRemovingItem"]');
                    }
                });
            }

            function updateTotals() {
                $.ajax({
                    url: '@Url.Action("GetBasket", "Basket")',
                    type: 'GET',
                    success: function (data) {
                        if (data) {
                            const formatted = currencySymbol + ' ' + data.totalPrice.toFixed(2);
                            $('#cart-subtotal').text(formatted);
                            $('#cart-subtotal-bottom').text(formatted);

                            // Update header cart count
                            $('.js-cart-items-count').text(data.totalCount || 0);
                        }
                    }
                });
            }
        });
    </script>
}