@using EcommerceCoza.BLL.ViewModels
@using Microsoft.AspNetCore.Mvc.Localization
@inject WebApplication4.Services.ICurrencyService CurrencyService
@inject IViewLocalizer Localizer
@model HeaderViewModel

@{
    var basketItems = Model.BasketItems;
    var basketItemsCount = basketItems?.Sum(x => x.Quantity) ?? 0;
    var basketTotalPrice = basketItems?.Sum(x => x.Quantity * x.Price) ?? 0;
}

<header id="header" class="header header-fullwidth header-transparent-bg">
    <div class="container">
        <div class="header-desk header-desk_type_1">
            <div class="logo">
                <a asp-controller="Home" asp-action="Index">
                    <img src="~/assets/images/logo.png" alt="Uomo" class="logo__image d-block" />
                </a>
            </div>

            <nav class="navigation">
                <ul class="navigation__list list-unstyled d-flex">
                    <li class="navigation__item">
                        <a asp-controller="Home" asp-action="Index" class="navigation__link">Home</a>
                    </li>
                    <li class="navigation__item">
                        <a asp-controller="Shop" asp-action="Index" class="navigation__link">Shop</a>
                    </li>
                    <li class="navigation__item">
                        <a asp-controller="Basket" asp-action="Index" class="navigation__link">Cart</a>
                    </li>
                    <li class="navigation__item">
                        <a asp-controller="Home" asp-action="About" class="navigation__link">About</a>
                    </li>
                    <li class="navigation__item">
                        <a asp-controller="Home" asp-action="Contact" class="navigation__link">Contact</a>
                    </li>
                </ul>
            </nav>

            <div class="header-tools d-flex align-items-center">
                <!-- Language selector -->
                <form asp-controller="Localization" asp-action="SetLanguage" method="post" class="me-2">
                    <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                    <select name="culture" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="en" selected="@((System.Threading.Thread.CurrentThread.CurrentUICulture.TwoLetterISOLanguageName == "en") ? "selected" : null)">EN</option>
                        <option value="ru" selected="@((System.Threading.Thread.CurrentThread.CurrentUICulture.TwoLetterISOLanguageName == "ru") ? "selected" : null)">RU</option>
                        <option value="az" selected="@((System.Threading.Thread.CurrentThread.CurrentUICulture.TwoLetterISOLanguageName == "az") ? "selected" : null)">AZ</option>
                    </select>
                </form>

                <!-- Currency selector -->
                <form asp-controller="Currency" asp-action="SetCurrency" method="post" class="me-2">
                    <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />
                    <select name="currency" class="form-select form-select-sm" onchange="this.form.submit()">
                        @{
                            var currentCurrency = CurrencyService.GetCurrentCurrency();
                        }
                        <option value="USD" selected="@(currentCurrency == WebApplication4.Models.Currency.USD ? "selected" : null)">USD ($)</option>
                        <option value="AZN" selected="@(currentCurrency == WebApplication4.Models.Currency.AZN ? "selected" : null)">AZN (₼)</option>
                        <option value="RUB" selected="@(currentCurrency == WebApplication4.Models.Currency.RUB ? "selected" : null)">RUB (₽)</option>
                    </select>
                </form>

                <!-- Theme toggle -->
                <button id="theme-toggle-btn" class="theme-toggle-btn me-2" type="button" aria-label="Toggle dark mode" aria-pressed="false" title="Toggle theme">
                    <span class="theme-toggle__icon icon-sun" aria-hidden="true">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <circle cx="10" cy="10" r="5" stroke="currentColor" stroke-width="1.5" />
                            <path d="M10 1v3M10 16v3M1 10h3M16 10h3M4.1 4.1l2.1 2.1M13.8 13.8l2.1 2.1M4.1 15.9l2.1-2.1M13.8 6.2l2.1-2.1" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" />
                        </svg>
                    </span>
                    <span class="theme-toggle__icon icon-moon" aria-hidden="true">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M12.9 1.75A8 8 0 0 0 10 17a8 8 0 0 1-6.5-12.6 7.5 7.5 0 1 1 9.4-2.65Z" stroke="currentColor" stroke-width="1.5" fill="none" />
                        </svg>
                    </span>
                </button>

                <!-- Search -->
                <div class="header-tools__item hover-container">
                    <div class="position-relative">
                        <a href="#" class="js-search-popup search-field__actor">
                            <svg class="d-block" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <use href="#icon_search" />
                            </svg>
                        </a>
                    </div>

                    <!-- Search Popup Content -->
                    <div class="search-popup" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9998; display: none; padding-top: 80px; overflow-y: auto;">
                        <div class="container">
                            <div class="search-field bg-body p-4 rounded shadow" style="max-width: 800px; margin: 0 auto; position: relative;">
                                <button class="btn-close position-absolute top-0 end-0 m-3 js-close-search" style="z-index: 10;"></button>
                                <div class="position-relative mb-3">
                                    <input id="headerSearchInput" class="search-field__input form-control form-control-lg" type="text" placeholder="Search products..." autocomplete="off">
                                    <button class="btn btn-link position-absolute top-50 end-0 translate-middle-y pe-3" type="button">
                                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                            <use href="#icon_search" />
                                        </svg>
                                    </button>
                                </div>

                                <!-- Search Results -->
                                <div id="searchResults" class="search-result" style="max-height: 500px; overflow-y: auto;"></div>
                                <div id="searchLoading" class="text-center py-4 d-none">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Searching...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Searching...</p>
                                </div>
                                <div id="searchNoResults" class="text-center text-muted py-4 d-none">
                                    <svg width="48" height="48" fill="currentColor" class="mb-2 opacity-50">
                                        <use href="#icon_search" />
                                    </svg>
                                    <p class="mb-0">No products found</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User account -->
                <div class="header-tools__item hover-container">
                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        <a asp-controller="Account" asp-action="Index" class="header-tools__item" title="My Account">
                            <svg class="d-block" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <use href="#icon_user" />
                            </svg>
                        </a>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login" class="header-tools__item" title="Login">
                            <svg class="d-block" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <use href="#icon_user" />
                            </svg>
                        </a>
                    }
                </div>

                <!-- Wishlist -->
                <a asp-controller="Wishlist" asp-action="Index" class="header-tools__item">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <use href="#icon_heart" />
                    </svg>
                </a>

                <!-- Basket / Cart -->
                <a asp-controller="Basket" asp-action="Index" class="header-tools__item header-tools__cart">
                    <svg class="d-block" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <use href="#icon_cart" />
                    </svg>
                    <span class="cart-amount d-block position-absolute js-cart-items-count header__cart-count">
                        @basketItemsCount
                    </span>
                </a>

                <!-- Logout -->
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <div class="header-tools__item">
                        <a asp-controller="Account" asp-action="Logout" class="header-tools__item" title="Logout">
                            <svg class="d-block" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <use href="#icon_logout" />
                            </svg>
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</header>